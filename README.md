# MySQL-Performance-Tuning-Guide

## 1. 连接配置优化

### 1.1 服务端配置

> 服务端配置即 MySQL 本身的配置

#### 1.1.1 增加可用连接数

例如压测时经常遇到的`error 1040: Too many connections`，可以修改环境变量 `max_connections` ，默认情况下服务端最大连接数为 151 个。

相关指令：

```sql
show variables like `max_connections`;
```

#### 1.1.2 及时释放不活动的连接

系统默认的客户端超市时间是28800s（8h），可以把这个值调小一点。

相关指令:

```sql
show variables like `wait_timeout`;
```

### 1.2 客户端优化

#### 1.2.1 使用连接池来复用连接

客户端能做的就是尽量减少和服务端建立连接的次数，已经建立的连接能凑合用就凑合用，别每次执行个 SQL 语句都创建个新连接，服务端和客户端的资源都会吃不消。

解决方案：使用**连接池**复用连接。

> 常见的数据库连接池有Druid（默认最大连接池大小：8）、Hikari（默认最大连接池大小：10）
>
> 注意：不要盲目地加大连接池的大小，系统执行效率反而可能降低。因为对于每一个连接，服务端都需要创建一个单独的线程去处理。在线程数超过CPU个数的情况下，CPU势必要通过分配时间片的方式进行线程的上下文切换，频繁的上下文切换会造成很大的性能开销。
>
> Hikari官方给出了一个关于 PostgreSQL 数据库连接池大小的建议值公式：`CPU核心数 * 2 + 1`，这个公式对于其他数据库一般来说也是适用的。

## 2. 架构优化

### 2.1 使用缓存

使用Redis，常用且简单的做法。

注意：

1. 注意MySQL和Redis的数据一致性
2. 注意Redis占用的内容（或者说注意缓存的数据量）

### 2.2 读写分离（集群、主从复制）

读写分离，将读和写分离到不同的服务器上，从而避免了读写冲突。

### 2.3 分库分表

### 2.4 消息队列

## 3. SQL分析与优化

### 3.1 慢查询

### 3.2 查看运行中的线程

### 3.3 查询存储引擎运行状态

### 3.4 EXPLAIN执行计划

### 3.5 SQL与索引优化

## 4. 存储引擎与表结构

### 4.1 选择正确的存储引擎

### 4.2 优化字段

## 5. 业务优化
